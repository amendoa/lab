on:
  push:
    branches:
      - main

name: Build and deploy demo
jobs:
  build-github-gists-as-cms-demo:
    name: Build Github Gists as CMS demo
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup PNPM
        uses: pnpm/action-setup@v4
        with:
          version: 8

      - name: Install dependencies
        working-directory: ./misc/github-gists-as-cms
        run: pnpm install

      - name: Build
        working-directory: ./misc/github-gists-as-cms
        env:
          WEBPACK_GIST_ID: facbd5afba99caa85c7e139e6ab1ad76
          WEBPACK_TMP_DIR: tmp
          WEBPACK_GITHUB_USERNAME: amendoa
        run: pnpm build

      - name: Upload build dist
        uses: actions/upload-artifact@v4
        with:
          name: github-gists-as-cms
          path: ./misc/github-gists-as-cms/dist

  build-core-demo:
    name: Build Core Demo
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Upload build dist
        uses: actions/upload-artifact@v4
        with:
          name: core-demo
          path: ./core/demo

  publish:
    name: Publish
    runs-on: ubuntu-latest
    needs:
      - build-github-gists-as-cms-demo
      - build-core-demo
    permissions:
      pages: write
      id-token: write
    steps:
      - name: Download core-demo dist
        uses: actions/download-artifact@v4
        with:
          name: core-demo
          path: ./public

      - name: Download github-gists-as-cms dist
        uses: actions/download-artifact@v4
        with:
          name: github-gists-as-cms
          path: ./public/github-gists-as-cms

      - name: Upload artifacts to Github Pages
        uses: actions/upload-artifact@v4
        with:
          name: github-pages
          path: ./public

      - name: Deploy to GitHub Pages
        uses: actions/deploy-pages@v4
